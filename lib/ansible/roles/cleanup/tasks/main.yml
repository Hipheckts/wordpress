---
- name:         Ensure logrotate runs hourly
  command:      mv /etc/cron.daily/logrotate /etc/cron.hourly/logrotate
  args:
    creates:    /etc/cron.hourly/logrotate
    removes:    /etc/cron.daily/logrotate
  sudo:         yes

- name:         Set up wpcron via user-level crontab
  cron:
  args:
    name:       "wpcron for {{stage}}"
    user:       deploy
    job:        "cd {{item.value}} && /usr/local/bin/wp core is-installed --path=$PWD --url='http://{{stage}}.{{domain}}/' && /usr/local/bin/wp cron event run --all --quiet --path=$PWD --url='http://{{stage}}.{{domain}}/'"
  with_dict:    "{{ wp_cron_path }}"
  when:         item.key == stage
  sudo:         yes

- name:         Configure varnish health-checking binary
  copy:         src=varnish-health.sh dest=/usr/local/bin/varnish-health.sh owner=deploy group=deploy mode=0755
  when:         role_varnish is defined
  sudo:         yes

- name:         Disable varnish health checking (as necessary) via user-level crontab
  cron:
  args:
    name:       "varnish health check for {{stage}}"
    user:       deploy
    state:      absent
  when:         role_varnish is not defined
  sudo:         yes

- name:         Set up varnish health checking via user-level crontab
  cron:
  args:
    name:       "varnish health check for {{stage}}"
    user:       deploy
    job:        "/usr/local/bin/varnish-health.sh {{stage}}.{{domain}}"
  when:         role_varnish is defined
  sudo:         yes

- name:         Generate init.d for installed evolution services
  template:     src=evolution-init-d dest=/etc/init.d/evolution-wordpress mode=0755
  sudo:         yes
