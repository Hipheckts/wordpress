---
- name:       Install pound package
  apt:        pkg=pound state=present
  sudo:       true

- name:       Register Pound major/minor version
  shell:      "pound -V 2>&1 | grep -i version | perl -pe 's|^.*?version ([0-9]+[.][0-9]+).*?$|$1|i'"
  register:   pound_version

- debug:      msg={{ pound_version.stdout }}

- include:    build.yml
  when:       pound_version.stdout < '2.6'

- name:       Copy pound configuration file
  template:   src=pound.cfg dest=/etc/pound/pound.cfg mode=0644
  notify:     restart pound
  sudo:       true

- name:       Copy SSL certificates
  copy:       src=./files/ssl/{{ item }}.{{ domain }}.pem dest=/etc/pound/{{ item }}.{{ domain }}.pem mode=0644
  with_items:
    - local
    - staging
    - production
  notify:     restart pound
  sudo:       true

- name:       Enable pound
  lineinfile: regexp='^startup=0' line='startup=1' dest=/etc/default/pound backup=yes
  notify:     restart pound
  sudo:       yes
