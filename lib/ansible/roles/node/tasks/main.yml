---
- name:           Remove old node repository if necessary
  apt_repository: repo='ppa:chris-lea/node.js' state=absent
  sudo:           yes

- name:           Ensure removal of old node source lists
  shell:          rm -f /etc/apt/sources.list.d/chris-lea-node_js-*.list
  ignore_errors:  true
  sudo:           yes

- name:           Fetch Nodesource apt key (from control)
  local_action:   get_url dest=/tmp/ns4x.gpg.key url=https://deb.nodesource.com/gpgkey/nodesource.gpg.key force=yes
  when:           not lookup('env','CI')

- name:           Add Nodesource apt key
  apt_key:        data="{{ lookup('file', '/tmp/ns4x.gpg.key') }}" state=present
  sudo:           yes
  when:           not lookup('env','CI')

- name:           Add Nodesource apt key
  apt_key:        url=https://deb.nodesource.com/gpgkey/nodesource.gpg.key state=present
  sudo:           yes
  when:           lookup('env','CI')

- name:           Add Nodesource 4.x repos
  apt_repository: repo={{item}} state=present update_cache=yes
  with_items:     "{{ node_repos }}"
  sudo:           yes

- name:           Install node
  apt:            pkg=nodejs state=present
  sudo:           yes
