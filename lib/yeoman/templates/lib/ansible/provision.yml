---
- hosts:                "{{ stage }}" # Easy execution via: `ansible-playbook provision.yml -e stage=local`
  gather_facts:         yes           # Host specs required for templates

  pre_tasks:
    - name:             Stop any existing evolution services
      command:          service evolution-wordpress stop removes=/etc/init.d/evolution-wordpress
      sudo:             yes

  roles:
    - common            # (Required) Base configuration
    - user              # (Required) User for SSH/Ansible/Capistrano auth
    - apache            # (Required) Web server (Soon: Nginx)
    - mysql             # (Required) Database server (Soon: Maria)
    - php               # (Required) PHP 5.3
    - node              # (Required) Tools for deployment (e.g. `bower`)
    - wp-cli            # (Required) CLI for managing WordPress

    # Optional Features
    <% if (props.ssl) { %>- pound             # (Optional) SSL support & decryption<% } %><% props.roles.map(function(role) { %>
    <%= role.checked ? '-' : '#' %> <%= role.value %><% }) %>

  post_tasks:
    - name:             Generate init.d for installed evolution services
      template:         src=templates/evolution-init-d dest=/etc/init.d/evolution-wordpress mode=0755
      sudo:             yes
